/*! vokal-ng-api Copyright Vokal 2016 */
!function(a,b){"function"==typeof define&&define.amd?define("vokal-ng-api",["humps"],function(a){return b(a)}):"object"==typeof exports?module.exports=b(require("humps")):b(humps)}(this,function(a){angular.module("vokal.API",["vokal.Humps"]).factory("API",["$http","$rootScope","$q","$location","$timeout","Humps",function(b,c,d,e,f,g){"use strict";function h(a){try{return decodeURIComponent(a)}catch(a){}}function i(a){var b,c,d={};return angular.forEach((a||"").split("&"),function(a){if(a&&(b=a.replace(/\+/g,"%20").split("="),c=h(b[0]),angular.isDefined(c))){var e=!angular.isDefined(b[1])||h(b[1]);hasOwnProperty.call(d,c)?angular.isArray(d[c])?d[c].push(e):d[c]=[d[c],e]:d[c]=e}}),d}function j(a){return encodeURIComponent(a).replace(/%40/gi,"@").replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%3B/gi,";").replace(/%20/g,"+").replace(/%7B/g,"{").replace(/%7D/g,"}").replace(/%5B/g,"[").replace(/%5D/g,"]").replace(/%22/g,'"').replace(/%5C/g,"\\")}var k=!1,l=[],m=[],n=!1,o=function(a){var b=a.split("?");return 1===b.length?{}:i(b[1])},p=function(b,c,d){if(!angular.isObject(c))return b;c=angular.extend({},o(b),c||{}),d&&d.transformHumps&&(c=a.decamelizeKeys(c,{separator:"_"})),b=b.split("?")[0];for(var e=Object.keys(c),f=[],g=0;g<e.length;g++){var h=e[g],i=c[h];angular.isObject(i)&&(i=JSON.stringify(i)),f.push(j(h)+"="+j(i))}return b+(f.length?"?"+f.join("&"):"")},q=function(a){this.globalHeaders=angular.copy(this.constructor.prototype.globalHeaders),a&&("undefined"!=typeof a.name&&(this.name=a.name),"undefined"!=typeof a.globalHeaders&&(this.globalHeaders=angular.copy(a.globalHeaders)),"undefined"!=typeof a.rootPath&&(this.rootPath=a.rootPath),"undefined"!=typeof a.transformHumps&&(this.transformHumps=a.transformHumps),"undefined"!=typeof a.cancelOnRouteChange&&(this.cancelOnRouteChange=a.cancelOnRouteChange),"undefined"!=typeof a.unauthorizedInterrupt&&(this.unauthorizedInterrupt=a.unauthorizedInterrupt),"undefined"!=typeof a.loginPath&&(this.loginPath=a.loginPath))};return q.prototype.name="",q.prototype.globalHeaders={},q.prototype.rootPath="",q.prototype.transformHumps=!0,q.prototype.cancelOnRouteChange=!1,q.prototype.unauthorizedInterrupt=!0,q.prototype.loginPath=null,q.prototype.extendHeaders=function(a){angular.extend(this.globalHeaders,a)},q.prototype.setKey=function(a){this.globalHeaders.AUTHORIZATION="string"==typeof a?a:"","string"!=typeof a&&"undefined"!=typeof a&&null!==a&&console.warn("setKey( key ) only accepts a String for parameter key")},q.prototype.getKey=function(){return this.globalHeaders.AUTHORIZATION},q.prototype.queryUrl=p,q.prototype.apiRequest=function(a,h,i){var j=this,o=d.defer(),p={method:a,url:this.rootPath+h,headers:this.globalHeaders,data:i||{},timeout:o.promise,ngName:this.name};if("postFile"===a?(this.globalHeaders["Content-Type"]=void 0,p.method="post",p.transformRequest=angular.identity):this.transformHumps&&(this.globalHeaders["Content-Type"]="application/json",p.transformRequest=g.requestToSnake(b.defaults.transformRequest),p.transformResponse=g.responseToCamel(b.defaults.transformResponse)),b(p).success(function(a,b){c.$broadcast("APIRequestComplete",p,a,b),c.$broadcast("APIRequestSuccess",p,a,b),o.resolve({data:a,options:p,status:b})}).error(function(b,g){if(c.$broadcast("APIRequestComplete",p,b,g),401===g&&e.path()!==j.loginPath){if(k)return void(n?j.repeatRequest({method:a,path:h,requestData:i,promise:o}):(l.push({method:a,path:h,requestData:i,promise:o}),m.push(o)));if(c.$broadcast("APIRequestUnauthorized",p,b,g),j.unauthorizedInterrupt===!0)return;if("function"==typeof j.unauthorizedInterrupt)return k=!0,l.push({method:a,path:h,requestData:i,promise:o}),m.push(o),void f(function(){j.unauthorizedInterrupt(b,p,g).then(function(){n=!0,d.all(m).finally(function(){n=!1,k=!1});for(var a=0;a<l.length;a++)j.repeatRequest(l[a])},function(a){k=!1,c.$broadcast("APIAuthorizationFailure",a||"")})},0)}c.$broadcast("APIRequestError",p,b,g),o.reject({data:b,options:p,status:g})}),c.$broadcast("APIRequestStart",p),this.cancelOnRouteChange)var q=c.$on("$routeChangeSuccess",function(){o.promise.$cancel("Request canceled",p),q()}),r=c.$on("APIRequestComplete",function(){q(),r()});return o.promise.$cancel=function(a,b){c.$broadcast("APIRequestCanceled",b,a),o.reject({data:a||"Request cancelled",options:b})},o.promise},q.prototype.$get=function(a,b){return this.apiRequest("get",p(a,b,{transformHumps:this.transformHumps}))},q.prototype.$post=function(a,b){return this.apiRequest("post",a,b)},q.prototype.$postFile=function(a,b){return this.apiRequest("postFile",a,b)},q.prototype.$put=function(a,b){return this.apiRequest("put",a,b)},q.prototype.$patch=function(a,b){return this.apiRequest("patch",a,b)},q.prototype.$delete=function(a){return this.apiRequest("delete",a)},q.prototype.repeatRequest=function(a){this.apiRequest(a.method,a.path,a.requestData).then(function(b){a.promise.resolve({data:b.data,options:b.options,status:b.status})},function(b){a.promise.reject({data:b.data,options:b.options,status:b.status})})},q}]),angular.module("vokal.Humps",[]).service("Humps",function(){"use strict";var b=function(a,b){return a=angular.isArray(a)?a:[a],a.concat(b)};this.responseToCamel=function(c){return b(c,function(b){return a.camelizeKeys(b)})},this.requestToSnake=function(c){return b(c,function(b){return"string"==typeof b?JSON.stringify(a.decamelizeKeys(JSON.parse(b),{separator:"_"})):a.decamelizeKeys(b,{separator:"_"})})}})});