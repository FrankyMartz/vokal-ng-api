/*! vokal-ng-api Copyright Vokal 2015 */
!function(a,b){"function"==typeof define&&define.amd?define("vokal-ng-api",["humps"],function(a){return b(a)}):"object"==typeof exports?module.exports=b(require("humps")):b(humps)}(this,function(a){angular.module("vokal.API",["vokal.Humps"]).factory("API",["$http","$rootScope","$q","Humps",function(b,c,d,e){"use strict";function f(a){try{return decodeURIComponent(a)}catch(b){}}function g(a){var b,c,d={};return angular.forEach((a||"").split("&"),function(a){if(a&&(b=a.replace(/\+/g,"%20").split("="),c=f(b[0]),angular.isDefined(c))){var e=angular.isDefined(b[1])?f(b[1]):!0;hasOwnProperty.call(d,c)?angular.isArray(d[c])?d[c].push(e):d[c]=[d[c],e]:d[c]=e}}),d}function h(a){return encodeURIComponent(a).replace(/%40/gi,"@").replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%3B/gi,";").replace(/%20/g,"+").replace(/%7B/g,"{").replace(/%7D/g,"}").replace(/%5B/g,"[").replace(/%5D/g,"]").replace(/%22/g,'"').replace(/%5C/g,"\\")}var i=function(a){var b=a.split("?");return 1===b.length?{}:g(b[1])},j=function(b,c,d){if(!angular.isObject(c))return b;c=angular.extend({},i(b),c||{}),d&&d.transformHumps&&(c=a.decamelizeKeys(c,{separator:"_"})),b=b.split("?")[0];for(var e=Object.keys(c),f=[],g=0;g<e.length;g++){var j=e[g],k=c[j];angular.isObject(k)&&(k=JSON.stringify(k)),f.push(h(j)+"="+h(k))}return b+(f.length?"?"+f.join("&"):"")},k=function(a){this.globalHeaders=angular.copy(this.constructor.prototype.globalHeaders),a&&("undefined"!=typeof a.globalHeaders&&(this.globalHeaders=angular.copy(a.globalHeaders)),"undefined"!=typeof a.rootPath&&(this.rootPath=a.rootPath),"undefined"!=typeof a.transformHumps&&(this.transformHumps=a.transformHumps),"undefined"!=typeof a.cancelOnRouteChange&&(this.cancelOnRouteChange=a.cancelOnRouteChange),"undefined"!=typeof a.unauthorizedInterrupt&&(this.unauthorizedInterrupt=a.unauthorizedInterrupt))};return k.prototype.globalHeaders={},k.prototype.rootPath="",k.prototype.transformHumps=!0,k.prototype.cancelOnRouteChange=!1,k.prototype.unauthorizedInterrupt=!0,k.prototype.extendHeaders=function(a){angular.extend(this.globalHeaders,a)},k.prototype.setKey=function(a){this.globalHeaders.AUTHORIZATION="string"==typeof a?a:"","string"!=typeof a&&"undefined"!=typeof a&&null!==a&&console.warn("setKey( key ) only accepts a String for parameter key")},k.prototype.getKey=function(){return this.globalHeaders.AUTHORIZATION},k.prototype.queryUrl=j,k.prototype.apiRequest=function(a,f,g){var h=this,i=d.defer(),j={method:a,url:this.rootPath+f,headers:this.globalHeaders,data:g||{},timeout:i.promise};if("postFile"===a?(this.globalHeaders["Content-Type"]=void 0,j.method="post",j.transformRequest=angular.identity):this.transformHumps&&(this.globalHeaders["Content-Type"]="application/json",j.transformRequest=e.requestToSnake(b.defaults.transformRequest),j.transformResponse=e.responseToCamel(b.defaults.transformResponse)),b(j).success(function(a,b){c.$broadcast("APIRequestComplete",j,a,b),c.$broadcast("APIRequestSuccess",j,a,b),i.resolve({data:a,options:j,status:b})}).error(function(a,b){c.$broadcast("APIRequestComplete",j,a,b),(401!==b&&403!==b||(c.$broadcast("APIRequestUnauthorized",j,a,b),!h.unauthorizedInterrupt))&&(c.$broadcast("APIRequestError",j,a,b),i.reject({data:a,options:j,status:b}))}),c.$broadcast("APIRequestStart",j),this.cancelOnRouteChange)var k=c.$on("$routeChangeSuccess",function(){i.promise.$cancel("Request canceled",j),k()}),l=c.$on("APIRequestComplete",function(){k(),l()});return i.promise.$cancel=function(a,b){c.$broadcast("APIRequestCanceled",b,a),i.reject({data:a||"Request cancelled",options:b})},i.promise},k.prototype.$get=function(a,b){return this.apiRequest("get",j(a,b,{transformHumps:this.transformHumps}))},k.prototype.$post=function(a,b){return this.apiRequest("post",a,b)},k.prototype.$postFile=function(a,b){return this.apiRequest("postFile",a,b)},k.prototype.$put=function(a,b){return this.apiRequest("put",a,b)},k.prototype.$patch=function(a,b){return this.apiRequest("patch",a,b)},k.prototype.$delete=function(a){return this.apiRequest("delete",a)},k}]),angular.module("vokal.Humps",[]).service("Humps",function(){"use strict";var b=function(a,b){return a=angular.isArray(a)?a:[a],a.concat(b)};this.responseToCamel=function(c){return b(c,function(b){return a.camelizeKeys(b)})},this.requestToSnake=function(c){return b(c,function(b){return"string"==typeof b?JSON.stringify(a.decamelizeKeys(JSON.parse(b),{separator:"_"})):a.decamelizeKeys(b,{separator:"_"})})}})});