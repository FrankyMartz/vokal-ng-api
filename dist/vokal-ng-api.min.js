/*! vokal-ng-api Copyright Vokal 2016 */
!function(a,b){"function"==typeof define&&define.amd?define("vokal-ng-api",["humps"],function(a){return b(a)}):"object"==typeof exports?module.exports=b(require("humps")):b(humps)}(this,function(a){angular.module("vokal.API",["vokal.Humps"]).factory("API",["$http","$rootScope","$q","$location","Humps",function(b,c,d,e,f){"use strict";function g(a){try{return decodeURIComponent(a)}catch(a){}}function h(a){var b,c,d={};return angular.forEach((a||"").split("&"),function(a){if(a&&(b=a.replace(/\+/g,"%20").split("="),c=g(b[0]),angular.isDefined(c))){var e=!angular.isDefined(b[1])||g(b[1]);hasOwnProperty.call(d,c)?angular.isArray(d[c])?d[c].push(e):d[c]=[d[c],e]:d[c]=e}}),d}function i(a){return encodeURIComponent(a).replace(/%40/gi,"@").replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%3B/gi,";").replace(/%20/g,"+").replace(/%7B/g,"{").replace(/%7D/g,"}").replace(/%5B/g,"[").replace(/%5D/g,"]").replace(/%22/g,'"').replace(/%5C/g,"\\")}var j=!1,k=[],l=[],m=!1,n=function(a){var b=a.split("?");return 1===b.length?{}:h(b[1])},o=function(b,c,d){if(!angular.isObject(c))return b;c=angular.extend({},n(b),c||{}),d&&d.transformHumps&&(c=a.decamelizeKeys(c,{separator:"_"})),b=b.split("?")[0];for(var e=Object.keys(c),f=[],g=0;g<e.length;g++){var h=e[g],j=c[h];angular.isObject(j)&&(j=JSON.stringify(j)),f.push(i(h)+"="+i(j))}return b+(f.length?"?"+f.join("&"):"")},p=function(a){this.globalHeaders=angular.copy(this.constructor.prototype.globalHeaders),a&&("undefined"!=typeof a.name&&(this.name=a.name),"undefined"!=typeof a.globalHeaders&&(this.globalHeaders=angular.copy(a.globalHeaders)),"undefined"!=typeof a.rootPath&&(this.rootPath=a.rootPath),"undefined"!=typeof a.transformHumps&&(this.transformHumps=a.transformHumps),"undefined"!=typeof a.cancelOnRouteChange&&(this.cancelOnRouteChange=a.cancelOnRouteChange),"undefined"!=typeof a.unauthorizedInterrupt&&(this.unauthorizedInterrupt=a.unauthorizedInterrupt),"undefined"!=typeof a.loginPath&&(this.loginPath=a.loginPath))};return p.prototype.name="",p.prototype.globalHeaders={},p.prototype.rootPath="",p.prototype.transformHumps=!0,p.prototype.cancelOnRouteChange=!1,p.prototype.unauthorizedInterrupt=!0,p.prototype.loginPath=null,p.prototype.extendHeaders=function(a){angular.extend(this.globalHeaders,a)},p.prototype.setKey=function(a){this.globalHeaders.AUTHORIZATION="string"==typeof a?a:"","string"!=typeof a&&"undefined"!=typeof a&&null!==a&&console.warn("setKey( key ) only accepts a String for parameter key")},p.prototype.getKey=function(){return this.globalHeaders.AUTHORIZATION},p.prototype.queryUrl=o,p.prototype.apiRequest=function(a,g,h){var i=this,n=d.defer(),o={method:a,url:this.rootPath+g,headers:this.globalHeaders,data:h||{},timeout:n.promise,ngName:this.name};if("postFile"===a?(this.globalHeaders["Content-Type"]=void 0,o.method="post",o.transformRequest=angular.identity):this.transformHumps&&(this.globalHeaders["Content-Type"]="application/json",o.transformRequest=f.requestToSnake(b.defaults.transformRequest),o.transformResponse=f.responseToCamel(b.defaults.transformResponse)),b(o).success(function(a,b){c.$broadcast("APIRequestComplete",o,a,b),c.$broadcast("APIRequestSuccess",o,a,b),n.resolve({data:a,options:o,status:b})}).error(function(b,f){if(c.$broadcast("APIRequestComplete",o,b,f),401===f&&e.path()!==i.loginPath)if(j)m?i.repeatRequest({method:a,path:g,requestData:h,promise:n}):(k.push({method:a,path:g,requestData:h,promise:n}),l.push(n));else{if(c.$broadcast("APIRequestUnauthorized",o,b,f),i.unauthorizedInterrupt===!0)return;if("function"==typeof i.unauthorizedInterrupt)return j=!0,k.push({method:a,path:g,requestData:h,promise:n}),l.push(n),void i.unauthorizedInterrupt(b,o,f).then(function(){m=!0,d.all(l).finally(function(){m=!1,j=!1});for(var a=0;a<k.length;a++)i.repeatRequest(k[a])},function(a){j=!1,c.$broadcast("APIAuthorizationFailure",a||"")})}c.$broadcast("APIRequestError",o,b,f),n.reject({data:b,options:o,status:f})}),c.$broadcast("APIRequestStart",o),this.cancelOnRouteChange)var p=c.$on("$routeChangeSuccess",function(){n.promise.$cancel("Request canceled",o),p()}),q=c.$on("APIRequestComplete",function(){p(),q()});return n.promise.$cancel=function(a,b){c.$broadcast("APIRequestCanceled",b,a),n.reject({data:a||"Request cancelled",options:b})},n.promise},p.prototype.$get=function(a,b){return this.apiRequest("get",o(a,b,{transformHumps:this.transformHumps}))},p.prototype.$post=function(a,b){return this.apiRequest("post",a,b)},p.prototype.$postFile=function(a,b){return this.apiRequest("postFile",a,b)},p.prototype.$put=function(a,b){return this.apiRequest("put",a,b)},p.prototype.$patch=function(a,b){return this.apiRequest("patch",a,b)},p.prototype.$delete=function(a){return this.apiRequest("delete",a)},p.prototype.repeatRequest=function(a){this.apiRequest(a.method,a.path,a.requestData).then(function(b){a.promise.resolve({data:b.data,options:b.options,status:b.status})},function(b){a.promise.reject({data:b.data,options:b.options,status:b.status})})},p}]),angular.module("vokal.Humps",[]).service("Humps",function(){"use strict";var b=function(a,b){return a=angular.isArray(a)?a:[a],a.concat(b)};this.responseToCamel=function(c){return b(c,function(b){return a.camelizeKeys(b)})},this.requestToSnake=function(c){return b(c,function(b){return"string"==typeof b?JSON.stringify(a.decamelizeKeys(JSON.parse(b),{separator:"_"})):a.decamelizeKeys(b,{separator:"_"})})}})});