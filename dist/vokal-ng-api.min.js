/*! vokal-ng-api Copyright Vokal Interactive 2015 */
angular.module("vokal.API",["vokal.Humps"]).provider("API",function(){"use strict";function tryDecodeURIComponent(value){try{return decodeURIComponent(value)}catch(e){}}function parseKeyValue(keyValue){var key_value,key,obj={};return angular.forEach((keyValue||"").split("&"),function(keyValue){if(keyValue&&(key_value=keyValue.replace(/\+/g,"%20").split("="),key=tryDecodeURIComponent(key_value[0]),angular.isDefined(key))){var val=angular.isDefined(key_value[1])?tryDecodeURIComponent(key_value[1]):!0;hasOwnProperty.call(obj,key)?angular.isArray(obj[key])?obj[key].push(val):obj[key]=[obj[key],val]:obj[key]=val}}),obj}function encodeUriQuery(val){return encodeURIComponent(val).replace(/%40/gi,"@").replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%3B/gi,";").replace(/%20/g,"+").replace(/%7B/g,"{").replace(/%7D/g,"}").replace(/%5B/g,"[").replace(/%5D/g,"]").replace(/%22/g,'"').replace(/%5C/g,"\\")}var globalHeaders={},rootPath="",that=this;this.transformHumps=!0,this.cancelOnRouteChange=!1,this.unauthorizedInterrupt=!0,this.setHeaders=function(headers){angular.extend(globalHeaders,headers)},this.setRootPath=function(path){rootPath=String(path)},this.$get=["$http","$rootScope","$q","Humps",function($http,$rootScope,$q,Humps){var apiRequest=function(method,path,requestData){var defer=$q.defer(),options={method:method,url:rootPath+path,headers:globalHeaders,data:requestData||{},timeout:defer.promise};if("postFile"===method?(globalHeaders["Content-Type"]=void 0,options.method="post",options.transformRequest=angular.identity):that.transformHumps&&(globalHeaders["Content-Type"]="application/json",options.transformRequest=Humps.requestToSnake($http.defaults.transformRequest),options.transformResponse=Humps.responseToCamel($http.defaults.transformResponse)),$http(options).success(function(data,status){$rootScope.$broadcast("APIRequestComplete",options,data,status),$rootScope.$broadcast("APIRequestSuccess",options,data,status),defer.resolve(data)}).error(function(data,status){$rootScope.$broadcast("APIRequestComplete",options,data,status),401===status||403===status?($rootScope.$broadcast("APIRequestUnauthorized",options,data,status),that.unauthorizedInterrupt||($rootScope.$broadcast("APIRequestError",options,data,status),defer.reject(data,status))):($rootScope.$broadcast("APIRequestError",options,data,status),defer.reject(data,status))}),$rootScope.$broadcast("APIRequestStart",options),that.cancelOnRouteChange)var routeMonitor=$rootScope.$on("$routeChangeSuccess",function(){defer.promise.$cancel("Request canceled",options),routeMonitor()}),removeRouteMonitor=$rootScope.$on("APIRequestComplete",function(){routeMonitor(),removeRouteMonitor()});return defer.promise.$cancel=function(message,options){$rootScope.$broadcast("APIRequestCanceled",options,message),defer.reject(message||"Request cancelled",options)},defer.promise},getQueryData=function(path){var pathAndQuery=path.split("?");return 1===pathAndQuery.length?{}:parseKeyValue(pathAndQuery[1])},queryUrl=function(path,requestData){if(!angular.isObject(requestData))return path;requestData=angular.extend({},getQueryData(path),requestData||{}),path=path.split("?")[0];for(var keys=Object.keys(requestData),queryParts=[],k=0;k<keys.length;k++){var key=keys[k],value=requestData[key];angular.isObject(value)&&(value=JSON.stringify(value)),queryParts.push(encodeUriQuery(key)+"="+encodeUriQuery(value))}return path+(queryParts.length?"?"+queryParts.join("&"):"")};return{setKey:function(key){globalHeaders.AUTHORIZATION=String(key)},getKey:function(){return globalHeaders.AUTHORIZATION},queryUrl:queryUrl,$get:function(path,requestData){return apiRequest("get",queryUrl(path,requestData))},$post:function(path,requestData){return apiRequest("post",path,requestData)},$postFile:function(path,requestData){return apiRequest("postFile",path,requestData)},$put:function(path,requestData){return apiRequest("put",path,requestData)},$patch:function(path,requestData){return apiRequest("patch",path,requestData)},$delete:function(path){return apiRequest("delete",path)}}}]}),angular.module("vokal.Humps",[]).service("Humps",function(){"use strict";var safeConcat=function(base,addition){return base=angular.isArray(base)?base:[base],base.concat(addition)};this.responseToCamel=function(defaultTransforms){return safeConcat(defaultTransforms,function(value){return humps.camelizeKeys(value)})},this.requestToSnake=function(defaultTransforms){return safeConcat(defaultTransforms,function(value){return"string"==typeof value?JSON.stringify(humps.decamelizeKeys(JSON.parse(value),"_")):humps.decamelizeKeys(value,"_")})}});